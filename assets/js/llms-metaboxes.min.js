!function(t){t.fn.llmsCollapsible=function(){return this.on("click",".llms-collapsible-header",function(){var e=t(this).closest(".llms-collapsible"),a=e.siblings(".llms-collapsible");e.toggleClass("opened"),e.find(".llms-collapsible-body").slideToggle(400),a.each(function(){t(this).removeClass("opened"),t(this).find(".llms-collapsible-body").slideUp(400)})}),this},window.llms=window.llms||{};var e=function(){this.repeaters={metaboxes:this,$repeaters:null,init:function(){var e=this;e.$repeaters=t(".llms-mb-list.repeater"),e.$repeaters.length&&(LLMS.wait_for(function(){return"undefined"!=typeof tinyMCE},function(){e.load(),e.bind()}),t("#post").on("submit",e.handle_submit))},bind:function(){var e=this;e.$repeaters.each(function(){var a=t(this),n=a.find(".llms-repeater-rows"),l=a.find(".llms-repeater-model");tinyMCE.EditorManager.execCommand("mceRemoveEditor",!0,l.find(".llms-mb-list.editor textarea").attr("id")),a.find(".llms-repeater-new-btn").on("click",function(){e.add_row(a,null,!0)}),n.sortable({handle:".llms-drag-handle",items:".llms-repeater-row",start:function(t,e){n.addClass("dragging")},stop:function(l,i){n.removeClass("dragging");var s=i.item.find("textarea.wp-editor-area");s.each(function(){var e=t(this).attr("id");tinyMCE.EditorManager.execCommand("mceRemoveEditor",!0,e),tinyMCE.EditorManager.execCommand("mceAddEditor",!0,e)}),e.save(a)}}),a.on("click",".llms-repeater-remove",function(n){n.stopPropagation();var l=t(this).closest(".llms-repeater-row");window.confirm(LLMS.l10n.translate("Are you sure you want to delete this template? This cannot be undone."))&&(l.remove(),setTimeout(function(){e.save(a)},1))})})},add_row:function(e,a,n){var l=this,i=e.find(".llms-repeater-rows"),s=e.find(".llms-repeater-model"),r=s.find(".llms-repeater-row").clone(),o=e.find(".llms-repeater-row").length,d=l.reindex(r,o);a&&t.each(a,function(t,e){r.find('[name^="'+t+'"]').val(e)}),setTimeout(function(){l.bind_row(r)},1),i.append(r),n&&r.find(".llms-collapsible-header").trigger("click"),tinyMCE.EditorManager.execCommand("mceAddEditor",!0,d),e.trigger("llms-new-repeater-row",{$row:r,data:a})},bind_row:function(t){this.bind_row_header(t),t.find(".llms-select2").llmsSelect2({width:"100%"}),this.metaboxes.bind_datepickers(t.find(".llms-datepicker")),this.metaboxes.bind_controllers(t.find("[data-is-controller]"))},bind_row_header:function(e){var a=e.find(".llms-repeater-title"),n=e.find(".llms-collapsible-header-title-field");a.attr("data-default",a.text()),n.on("keyup focusout blur",function(){var e=t(this).val();e||(e=a.attr("data-default")),a.text(e)}).trigger("keyup")},handle_submit:function(e){e.preventDefault();var a,n=window.llms.metaboxes.repeaters,l=0;n.$repeaters.each(function(){n.save(t(this))}),a=setInterval(function(){l>=59||!t(".llms-mb-list.repeater.processing").length?(clearInterval(a),t("#post").off("submit",this.handle_submit),t("#publish").trigger("click")):l++},1e3)},load:function(){var e=this;e.$repeaters.each(function(){var a=t(this);e.store(a,"load",function(n){t.each(n.data,function(t,n){e.add_row(a,n,!1)}),a.find(".llms-repeater-rows .llms-repeater-row").each(function(){e.bind_row(t(this))})})})},reindex:function(e,a){function n(e,n){e.each(function(){var e=t(this).attr(n);t(this).attr(n,e.replace(l,a))})}var l=e.attr("data-row-order"),i=e.find(".llms-mb-list.editor textarea");return tinyMCE.EditorManager.execCommand("mceRemoveEditor",!0,i.attr("id")),e.attr("data-row-order",a),n(e,"data-row-order"),n(e.find("button.insert-media"),"data-editor"),n(e.find('input[name^="_llms"], textarea[name^="_llms"], select[name^="_llms"]'),"id"),n(e.find('input[name^="_llms"], textarea[name^="_llms"], select[name^="_llms"]'),"name"),n(e.find("[data-controller]"),"data-controller"),n(e.find("[data-controller]"),"data-controller"),n(e.find("button.wp-switch-editor"),"data-wp-editor-id"),n(e.find("button.wp-switch-editor"),"id"),n(e.find(".wp-editor-tools"),"id"),n(e.find(".wp-editor-container"),"id"),i.attr("id")},save:function(t){this.store(t,"save")},serialize:function(e){var a=[];return e.find(".llms-repeater-rows .llms-repeater-row").each(function(){var e={};t(this).find('input[name^="_llms"], select[name^="_llms"]').each(function(){e[t(this).attr("name")]=t(this).val()}),t(this).find('textarea[name^="_llms"]').each(function(){var a=t(this).attr("name");tinyMCE.editors[a]?e[a]=tinyMCE.editors[a].getContent():e[a]=t(this).val()}),a.push(e)}),a},store:function(t,e,a){a=a||function(){};var n=this,l={action:t.find(".llms-repeater-field-handler").val(),store_action:e};"save"===e&&(l.rows=n.serialize(t)),LLMS.Ajax.call({data:l,beforeSend:function(){t.addClass("processing"),LLMS.Spinner.start(t)},success:function(e){a(e),LLMS.Spinner.stop(t),t.removeClass("processing")}})}},this.repeaters.init(),this.init=function(){var e=this;t(".llms-select2-post").each(function(){e.post_select(t(this))}),t(".llms-select2-student").llmsStudentsSelect2(),t(".llms-collapsible-group").llmsCollapsible(),this.bind_tabs();var a=[{selector:t(".llms-datepicker"),func:"bind_datepickers"},{selector:t(".llms-select2"),func:function(t){t.llmsSelect2({width:"100%"})}},{selector:t('input[type="checkbox"][data-controls]'),func:"bind_cb_controllers"},{selector:t("[data-is-controller]"),func:"bind_controllers"},{selector:t(".llms-table"),func:"bind_tables"},{selector:t(".llms-merge-code-wrapper"),func:"bind_merge_code_buttons"},{selector:t("a.llms-editable"),func:"bind_editables"}];if(t.each(a,function(a,n){if(n.selector.length){var l=n.selector.filter(function(){return 0===t(this).closest(".llms-repeater-model").length});"string"==typeof n.func?e[n.func](l):"function"==typeof n.func&&n.func(l)}}),window.llms.post.post_type){var n="bind_"+window.llms.post.post_type;"function"==typeof this[n]&&this[n]()}},this.bind_cb_controllers=function(e){e=e||t('input[type="checkbox"][data-controls]'),e.each(function(){var e=t(this),a=t(e.attr("data-controls")).closest(".llms-mb-list");e.on("change",function(){t(this).is(":checked")?a.slideDown(200):a.slideUp(200)}),e.trigger("change")})},this.bind_controllers=function(e){e=e||t("[data-is-controller]"),e.each(function(){var e,a=t(this),n=t('[data-controller="#'+a.attr("id")+'"]');a.on("change",function(){e="checkbox"===a.attr("type")?a.is(":checked")?a.val():"false":a.val(),n.each(function(){var a=t(this).attr("data-controller-value"),n=[];-1!==a.indexOf(",")?n=a.split(","):n.push(a),-1!==n.indexOf(e)?t(this).slideDown(200):t(this).slideUp(200)})}),a.trigger("change")})},this.bind_datepicker=function(t){var e=t.attr("data-format")||"mm/dd/yy",a=t.attr("data-max-date")||null,n=t.attr("data-min-date")||null;t.datepicker({dateFormat:e,maxDate:a,minDate:n})},this.bind_datepickers=function(e){var a=this;e=e||t(".llms-datepicker"),e.each(function(){a.bind_datepicker(t(this))})},this.bind_editables=function(){function e(e){var n,l=e.find("label").clone(),i=e.attr("data-llms-editable"),s=e.attr("data-llms-editable-type"),r=e.attr("data-llms-editable-required")||"no",o=e.attr("data-llms-editable-value");if(r="yes"===r?' required="required"':"","select"===s){var d,c=JSON.parse(e.attr("data-llms-editable-options"));n=t('<select name="'+i+'"'+r+" />");for(var m in c)d=o===m?' selected="selected"':"",n.append('<option value="'+m+'"'+d+">"+c[m]+"</option>")}else if("datetime"===s){n=t('<div class="llms-datetime-field" />'),o=JSON.parse(o);var u=e.attr("data-llms-editable-date-format")||"",f=e.attr("data-llms-editable-date-min")||"",p=e.attr("data-llms-editable-date-max")||"";$picker=t('<input class="llms-date-input llms-datepicker" data-format="'+u+'" data-max-date="'+p+'" data-min-date="'+f+'" name="'+i+'[date]" type="text" value="'+o.date+'">'),a.bind_datepicker($picker),n.append($picker),n.append("<em>@</em>"),n.append('<input class="llms-time-input" max="23" min="0" name="'+i+'[hour]" type="number" value="'+o.hour+'">'),n.append("<em>:</em>"),n.append('<input class="llms-time-input" max="59" min="0" name="'+i+'[minute]" type="number" value="'+o.minute+'">')}else n=t('<input name="'+i+'" type="'+s+'" value="'+o+'"'+r+">");e.empty().append(l).append(n)}var a=this;t("a.llms-editable").on("click",function(a){a.preventDefault();var n,l=t(this);n=l.attr("data-fields")?t(l.attr("data-fields")):l.closest(".llms-metabox-section").find("[data-llms-editable]"),l.remove(),n.each(function(){e(t(this))})})},this.bind_llms_engagement=function(){var e=this;t("#_llms_engagement_type").on("change",function(){t("#_llms_engagement").trigger("llms-engagement-type-change",t(this).val())}),t("#_llms_engagement").on("llms-engagement-type-change",function(a,n){var l=t(this);switch(n){case"achievement":case"certificate":case"email":var i="llms_"+n;l.val(null).attr("data-post-type",i).trigger("change"),e.post_select(l);break;default:l.trigger("llms-engagement-type-change-external",n)}})},this.bind_llms_membership=function(){t('a[href="#llms-course-remove"]').on("click",function(e){e.preventDefault();var a=t(this),n=a.closest("tr"),l=a.closest(".llms-mb-list");LLMS.Spinner.start(l),window.LLMS.Ajax.call({data:{action:"membership_remove_auto_enroll_course",course_id:a.attr("data-id")},beforeSend:function(){l.find("p.error").remove()},success:function(t){t.success?(n.fadeOut(200),setTimeout(function(){n.remove()},400)):l.prepend('<p class="error">'+t.message+"</p>"),LLMS.Spinner.stop(l)}})}),t('a[href="#llms-course-bulk-enroll"]').on("click",function(e){e.preventDefault();var a=t(this),n=(a.closest("tr"),a.closest(".llms-mb-list"));window.confirm(LLMS.l10n.translate("membership_bulk_enrollment_warning"))&&(LLMS.Spinner.start(n),window.LLMS.Ajax.call({data:{action:"bulk_enroll_membership_into_course",course_id:a.attr("data-id")},beforeSend:function(){n.find("p.error").remove()},success:function(t){t.success?a.replaceWith('<strong style="float:right;">'+t.data.message+"&nbsp;&nbsp;</strong>"):n.prepend('<p class="error">'+t.message+"</p>"),LLMS.Spinner.stop(n)}}))})},this.bind_llms_order=function(){t('button[name="llms-refund-toggle"]').on("click",function(){var e=t(this),a=e.closest("tr"),n=a.attr("data-transaction-id"),l=e.attr("data-refundable"),i="1"===e.attr("data-gateway-supports"),s=e.attr("data-gateway"),r=t("#llms-txn-refund-model .llms-txn-refund-form").clone(),o=r.find(".gateway-btn");"remove"!==e.attr("data-action")?(e.text(LLMS.l10n.translate("Cancel")),e.attr("data-action","remove"),r.find("input").removeAttr("disabled"),r.find('input[name="llms_refund_amount"]').attr("max",l),r.find('input[name="llms_refund_txn_id"]').val(n),i&&(o.find(".llms-gateway-title").text(s),o.show()),a.after(r)):(e.text(LLMS.l10n.translate("Refund")),e.attr("data-action",""),a.next("tr").remove())}),t('button[name="llms-manual-txn-toggle"]').on("click",function(){var e=t(this),a=e.closest("tr"),n=t("#llms-manual-txn-model .llms-manual-txn-form").clone();"remove"!==e.attr("data-action")?(e.text(LLMS.l10n.translate("Cancel")),e.attr("data-action","remove"),n.find("input").removeAttr("disabled"),a.after(n)):(e.text(LLMS.l10n.translate("Record a Manual Payment")),e.attr("data-action",""),a.next("tr").remove())}),t(".llms-metabox").one("focus",'.llms-metabox-field[data-llms-editable="payment_gateway"] select',function(){t(this).attr("data-original-value")||t(this).attr("data-original-value",t(this).val())}),t(".llms-metabox").on("change",'.llms-metabox-field[data-llms-editable="payment_gateway"] select',function(){var e=t(this),a=e.val(),n=JSON.parse(e.closest(".llms-metabox-field").attr("data-gateway-fields")),l=n[a];for(var i in l){var s=t('input[name="'+l[i].name+'"]'),r=s.closest(".llms-metabox-field");s.attr("value",""),l[i].enabled?(r.show(),s.attr("required","required"),a===e.attr("data-original-value")&&s.val(r.attr("data-llms-editable-value"))):(s.removeAttr("required"),r.hide())}})},this.bind_merge_code_buttons=function(e){e=e||t(".llms-merge-code-wrapper"),e.find(".llms-merge-code-button").on("click",function(){t(this).next(".llms-merge-codes").toggleClass("active")}),e.find(".llms-merge-codes li").on("click",function(){var e=t(this),a=e.closest(".llms-merge-codes"),n=a.attr("data-target"),l=e.attr("data-code");if(-1===n.indexOf("#")){var i=window.tinymce.editors[n];i?i.insertContent(l):alert(LLMS.l10n.translate("Copy this code and paste it into the desired area")+": "+l)}else t(n).val(t(n).val()+l);a.removeClass("active")})},this.bind_tabs=function(){t(".llms-nav-tab-wrapper .tabs li").on("click",function(){var e=t(this),a=e.closest(".llms-mb-container"),n=e.attr("data-tab");e.siblings().removeClass("llms-active"),a.find(".tab-content").removeClass("llms-active"),e.addClass("llms-active"),t("#"+n).addClass("llms-active")})},this.post_select=function(e){var a=e.attr("data-post-type")||post,n=e.attr("data-post-type")||!1;e.llmsSelect2({allowClear:n,ajax:{dataType:"JSON",delay:250,method:"POST",url:window.ajaxurl,data:function(t){return{action:"select2_query_posts",page:t.page?t.page-1:0,post_type:a,term:t.term,_ajax_nonce:wp_ajax_data.nonce}},processResults:function(e,a){function n(e){return Array.isArray(e)?t.map(e,function(t){return l(t)}):t.map(e,function(t){return{text:t.label,children:n(t.items)}})}function l(t){return{text:t.name,id:t.id}}return{results:n(e.items),pagination:{more:e.more}}}},cache:!0,width:"100%"})},this.bind_tables=function(){t('.llms-table button[name="llms-expand-table"]').on("click",function(){var e=t(this),a=e.closest(".llms-table");if(e.attr("data-text")){var n=e.text();e.text(e.attr("data-text")),e.attr("data-text",n)}a.find(".expandable").each(function(){t(this).hasClass("closed")?t(this).addClass("opened").removeClass("closed"):t(this).addClass("closed").removeClass("opened")})})},this.init()};window.llms.metaboxes=new e}(jQuery);