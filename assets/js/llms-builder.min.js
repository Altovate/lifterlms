!function(e){function t(){e(".llms-course-builder").height(e(window).height()-62)}var s={$elements:{$main:e(".llms-builder-main")},Collections:{},Models:{},Views:{},Methods:{get_last_section:function(){return i.Syllabus.collection.at(i.Syllabus.collection.length-1)},draggable:function(){e("#llms-new-section").draggable({cancel:!1,connectToSortable:".llms-sections",helper:function(){var e=new s.Models.Section({id:_.uniqueId("section_temp_")});return new s.Views.Section({model:e}).render().$el},start:function(){e(".llms-sections").addClass("dragging")},stop:function(){e(".llms-sections").removeClass("dragging")}}),e("#llms-new-lesson").draggable({cancel:!1,connectToSortable:".llms-lessons",helper:function(){var e=new s.Models.Lesson({id:_.uniqueId("lesson_temp_")});return new s.Views.Lesson({model:e}).render().$el},start:function(){e(".llms-lessons").addClass("dragging")},stop:function(){e(".llms-lessons").removeClass("dragging")}})},sortable:function(){e(".llms-sections").sortable({cursor:"move",cursorAt:{top:10,left:10},handle:".drag-section",items:".llms-section",placeholder:"llms-section llms-sortable-placeholder",tolerance:"pointer",start:function(t,s){s.item.css("height","auto"),e(".llms-sections").addClass("dragging")},stop:function(t,s){s.item.trigger("drop-section",s.item.index()),e(".llms-sections").removeClass("dragging")}}),e(".llms-lessons").sortable({cursor:"move",cursorAt:{top:10,left:10},connectWith:".llms-lessons",handle:".drag-lesson",items:".llms-lesson",placeholder:"llms-lesson llms-sortable-placeholder",tolerance:"pointer",start:function(t,s){e(".llms-lessons").addClass("dragging")},stop:function(t,s){t.stopPropagation();var i=s.item.attr("data-section-id"),n=s.item.closest(".llms-section").attr("data-id");s.item.trigger("drop-lesson",[s.item,n,i]),s.item.removeAttr("style").closest(".llms-section").addClass("opened"),e(".llms-lessons").removeClass("dragging")},receive:function(e,t){t.item.trigger("update-parent",t.item),t.item.removeAttr("style").closest(".llms-section").addClass("opened")},over:function(t,s){e("#"+t.target.offsetParent.id).addClass("hover-opened")},out:function(t,s){e("#"+t.target.offsetParent.id).removeClass("hover-opened")}})}},Mixins:{EditableView:{events:{"focusout .llms-editable-title":"on_blur","keydown .llms-editable-title":"on_keydown"},has_changed:function(t){var s=e(t.target);return s.attr("data-original-content")!==s.text()},on_blur:function(e){e.stopPropagation();var t=this.has_changed(e);t&&this.save_edits(e)},on_keydown:function(e){e.stopPropagation();var t=e.which||e.keyCode;switch(t){case 13:e.preventDefault(),e.target.blur();break;case 27:e.preventDefault(),this.revert_edits(e),e.target.blur()}},revert_edits:function(t){var s=e(t.target),i=s.attr("data-original-content");s.text(i)},save_edits:function(t){var s=e(t.target),n=s.text(),o="edit_"+this.model.id;this.model.set("title",n).save(null,{beforeSend:function(){i.Status.add(o)},success:function(e){i.Status.remove(o)}})}},ShiftableView:{events:{"click .llms-action-icon.shift-down":"shift_down","click .llms-action-icon.shift-up":"shift_up"},shift_down:function(e){e.stopPropagation(),e.preventDefault(),this.$el.trigger("update-sort",[this.model,this.model.get("order")+1,this.model.collection])},shift_up:function(e){e.stopPropagation(),e.preventDefault(),this.$el.trigger("update-sort",[this.model,this.model.get("order")-1,this.model.collection])}},SortableView:{events:{"update-sort":"update_sort"},sort_collection:function(e){e.length&&e.each(function(e,t){e.set("order",t+1)}),e.trigger("rerender")},update_sort:function(e,t,s,i,n,o){e.stopPropagation(),o=void 0===o||o;var l=!n||i===n;remove_from_collection=l?i:n,remove_from_collection&&remove_from_collection.remove(t),remove_from_collection&&!l&&(this.sort_collection(n),n.sync_order()),i.add(t,{at:s-1}),this.sort_collection(i),o&&i.sync_order()}},SortableCollection:{comparator:"order",events:{"change:order":"sort"},next_order:function(){return this.length?this.last().get("order")+1:1},sync_order:function(){var e=_.uniqueId("saving_");this.sync("update",this,{beforeSend:function(){i.Status.add(e)},success:function(t){i.Status.remove(e)}})}},Syncable:{url:ajaxurl,action:"llms_builder",sync:function(e,t,s){if("undefined"==typeof s.data&&(s.data={}),t instanceof Backbone.Model?object_type="model":t instanceof Backbone.Collection&&(object_type="collection"),s.data.course_id=window.llms_builder.course.id,s.data.action_type=e,s.data.object_type=object_type,s.data.data_type=t.type_id,s.data._ajax_nonce=wp_ajax_data.nonce,void 0===s.data.action&&void 0!==this.action&&(s.data.action=this.action),"read"===e)return Backbone.sync(e,t,s);var i=this.toJSON(),n={};return i instanceof Array?n.models=i:n.model=i,_.extend(s.data,n),s.emulateJSON=!0,Backbone.sync.call(this,"create",t,s)}}}};s.Models.Course=Backbone.Model.extend(_.defaults({type_id:"course",defaults:function(){return{title:"New Course",edit_url:"",view_url:""}}},s.Mixins.Syncable)),s.Models.Lesson=Backbone.Model.extend(_.defaults({type_id:"lesson",defaults:function(){var e=this.collection?this.collection.next_order():1,t=s.Methods.get_last_section().id;return{title:"New Lesson",type:"lesson",order:e,section_id:t,is_last:!1,edit_url:"",view_url:"",date_available:"",days_before_available:"",drip_method:"",has_content:!1,is_free:!1,prerequisite:!1,quiz:!1}},initialize:function(){this.set({is_last:this.is_last()},{silent:!0}),this.on("change:order",function(){this.set({is_last:this.is_last()},{silent:!0})})},is_last:function(){return this.collection&&this.collection.length===this.get("order")},get_section:function(){return i.Syllabus.collection.get(this.get("section_id"))}},s.Mixins.Syncable)),s.Models.Section=Backbone.Model.extend(_.defaults({type_id:"section",defaults:function(){var e=this.collection?this.collection.next_order():1;return{active:!1,title:"New Section",type:"section",order:e,is_last:!1}},get_next:function(){return this.collection.at(this.collection.indexOf(this)+1)},get_prev:function(){return this.collection.at(this.collection.indexOf(this)-1)},initialize:function(){this.set({is_last:this.is_last()},{silent:!0}),this.on("change:order",function(){this.set({is_last:this.is_last()},{silent:!0})})},is_last:function(){return this.collection&&this.get("order")===this.collection.length}},s.Mixins.Syncable)),s.Collections.Lessons=Backbone.Collection.extend(_.defaults({model:s.Models.Lesson,type_id:"lesson"},s.Mixins.Syncable,s.Mixins.SortableCollection)),s.Collections.Sections=Backbone.Collection.extend(_.defaults({model:s.Models.Section,type_id:"section",parse:function(e){return e.data}},s.Mixins.Syncable,s.Mixins.SortableCollection)),s.Views.Course=Backbone.View.extend(_.defaults({attributes:function(){return{"data-id":this.model.id}},className:"llms-builder-item llms-lesson",el:"#llms-course-info",id:function(){return"llms-course-"+this.model.id},tagName:"div",template:wp.template("llms-course-template"),initialize:function(){this.render(),this.listenTo(this.model,"sync",this.render)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this}},s.Mixins.EditableView)),s.Views.Lesson=Backbone.View.extend(_.defaults({attributes:function(){return{"data-id":this.model.id,"data-section-id":this.model.get("section_id")}},className:"llms-builder-item llms-lesson",events:_.defaults({"drop-lesson":"drop","update-parent":"update_parent","click .llms-action-icon.section-prev":"section_prev","click .llms-action-icon.section-next":"section_next","click .llms-action-icon.trash":"delete_lesson"},s.Mixins.EditableView.events,s.Mixins.ShiftableView.events),id:function(){return"llms-lesson-"+this.model.id},tagName:"li",template:wp.template("llms-lesson-template"),delete_lesson:function(e){e.stopPropagation(),e.preventDefault();var t=LLMS.l10n.translate("Are you sure you want to permanently delete this lesson?");if(window.confirm(t)){var s="delete_"+this.model.id;this.model.destroy({beforeSend:function(){i.Status.add(s)},success:function(e){i.Status.remove(s)}})}},drop:function(e,t,s,n){var o=this,l=i.Syllabus.collection.get(s).Lessons.collection,a=this.model.collection?i.Syllabus.collection.get(n).Lessons.collection:null,c=!0;if(!this.model.collection){var r=o.model.id;c=!1,o.model.set("section_id",s),l.create(o.model,{beforeSend:function(){i.Status.add(r)},success:function(e){i.Status.remove(r),o.model.collection.sync_order()}})}this.$el.trigger("update-sort",[this.model,t.index()+1,l,a,c])},initialize:function(){this.listenTo(this.model,"sync",this.render)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},section_next:function(){var t=this.model.get_section(),s=t.get_next(),i=t.Lessons.collection;to_collection=s.Lessons.collection,e("#llms-section-"+s.id).addClass("opened"),this.model.set("section_id",s.id),this.$el.trigger("update-sort",[this.model,1,to_collection,i])},section_prev:function(){var t=this.model.get_section(),s=t.get_prev(),i=t.Lessons.collection;to_collection=s.Lessons.collection,e("#llms-section-"+s.id).addClass("opened"),this.model.set("section_id",s.id),this.$el.trigger("update-sort",[this.model,to_collection.next_order(),to_collection,i])},update_parent:function(t,s){this.model.set("section_id",e(s).closest(".llms-section").attr("data-id"))}},s.Mixins.EditableView,s.Mixins.ShiftableView)),s.Views.LessonSearchPopover=Backbone.View.extend({events:{"select2:select":"add_lesson"},tagName:"select",add_lesson:function(e){i.Tools.create_item("lesson",{id:e.params.data.id,title:e.params.data.title})},render:function(){var t=this;return setTimeout(function(){t.$el.llmsSelect2({ajax:{dataType:"JSON",delay:250,method:"POST",url:window.ajaxurl,data:function(e){return{action:"llms_builder",action_type:"search",course_id:window.llms_builder.course.id,term:e.term,page:e.page,_ajax_nonce:wp_ajax_data.nonce}},error:function(e,t,s){console.log(t,s)}},placeholder:LLMS.l10n.translate("Search for existing lessons..."),dropdownParent:e(".webui-popover-inner"),width:"100%"})},0),this}}),s.Views.Section=Backbone.View.extend(_.defaults({attributes:function(){return{"data-id":this.model.id}},className:"llms-builder-item llms-section",events:_.defaults({"drop-section":"drop","click .llms-action-icon.expand":"lessons_show","click .llms-action-icon.collapse":"lessons_hide","click .llms-action-icon.trash":"delete_section"},s.Mixins.EditableView.events,s.Mixins.ShiftableView.events),id:function(){return"llms-section-"+this.model.id},tagName:"li",template:wp.template("llms-section-template"),delete_section:function(e){if(e.stopPropagation(),e.preventDefault(),this.model.Lessons.collection.length)return void alert(LLMS.l10n.translate("You must remove all lessons before deleting a section."));var t="delete_"+this.model.id;this.model.destroy({beforeSend:function(){i.Status.add(t)},success:function(e){i.Status.remove(t)}})},drop:function(e,t){var s=this,n=!0;if(!this.model.collection){var o=s.model.id;n=!1,i.Syllabus.collection.create(s.model,{beforeSend:function(){i.Status.add(o)},success:function(e){i.Status.remove(o),s.model.collection.sync_order()}})}s.$el.trigger("update-sort",[s.model,t+1,s.model.collection,null,n])},initialize:function(){this.listenTo(this.model,"sync",this.render),this.listenTo(this.model,"change:active",this.toggle_active)},lessons_hide:function(e){e.preventDefault(),this.$el.removeClass("opened")},lessons_show:function(e){e.preventDefault(),this.$el.addClass("opened")},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.model.Lessons=new s.Views.LessonList({el:this.$el.find(".llms-lessons"),collection:new s.Collections.Lessons}),this.model.Lessons.collection.add(this.model.get("lessons")),this.$el.attr("id")!=this.model.id&&(this.$el.attr("id",this.id()),this.$el.attr(this.attributes())),this}},s.Mixins.EditableView,s.Mixins.ShiftableView)),s.Views.LessonList=Backbone.View.extend(_.defaults({add_one:function(e){var t=new s.Views.Lesson({model:e});this.$el.append(t.render().el)},destroy_one:function(e,t){this.sort_collection(t),t.sync_order()},initialize:function(){this.listenTo(this.collection,"add",this.add_one),this.listenTo(this.collection,"destroy",this.destroy_one),this.listenTo(this.collection,"rerender",this.render),s.Methods.sortable()},render:function(){return this.$el.children().remove(),this.collection.each(this.add_one,this),this}},s.Mixins.SortableView)),s.Views.SectionList=Backbone.View.extend(_.defaults({el:e("#llms-sections"),collection:new s.Collections.Sections,add_one:function(e){var t=new s.Views.Section({model:e});this.$el.append(t.render().el)},destroy_one:function(e,t){this.sort_collection(t),t.sync_order()},initialize:function(){this.listenTo(this.collection,"add",this.add_one),this.listenTo(this.collection,"destroy",this.destroy_one),this.listenTo(this.collection,"rerender",this.render),this.collection.fetch({beforeSend:function(){s.$elements.$main.addClass("loading"),LLMS.Spinner.start(s.$elements.$main)},success:function(t){s.$elements.$main.removeClass("loading"),LLMS.Spinner.stop(s.$elements.$main),s.Methods.draggable(),s.Methods.sortable(),LLMS.Spinner.start(e("#llms-spinner-el"),"small")}})},render:function(){return this.$el.children().remove(),this.collection.length&&this.collection.each(this.add_one,this),this}},s.Mixins.SortableView)),s.Views.Tools=Backbone.View.extend({el:e("#llms-builder-tools"),events:{"click button.llms-add-item":"add_item","click button#llms-existing-lesson":"show_search_popover","click a.bulk-toggle":"bulk_toggle"},initialize:function(){this.listenTo(i.Syllabus.collection,"add",this.maybe_disable),this.listenTo(i.Syllabus.collection,"remove",this.maybe_disable),this.listenTo(i.Syllabus.collection,"sync",this.maybe_disable)},add_item:function(t){t.preventDefault();var s=e(t.target),i=s.attr("data-model");this.create_item(i,{id:_.uniqueId(i+"_temp_")})},bulk_toggle:function(t){t.preventDefault();var s=e(t.target),i=s.attr("data-action");e(".llms-section .llms-action-icon."+i).trigger("click")},create_item:function(t,n){var o="section"===t?i.Syllabus.collection:s.Methods.get_last_section().Lessons.collection;o.create(n,{beforeSend:function(){i.Status.add(n.id)},success:function(e){i.Status.remove(n.id)}});var l=e("#llms-"+t+"-"+n.id);l.addClass("brand-new"),setTimeout(function(){l.removeClass("brand-new")},10),"lesson"===t&&l.closest(".llms-section").addClass("opened");var a=e("#llms-course-syllabus");a.animate({scrollTop:a[0].scrollHeight-a[0].clientHeight},200),s.Methods.sortable()},maybe_disable:function(){var t=e("#llms-new-lesson, #llms-existing-lesson");i.Syllabus.collection.length?t.removeAttr("disabled"):t.attr("disabled","disabled")},show_search_popover:function(t){WebuiPopovers.show(t.target,{animation:"pop",backdrop:!0,content:(new s.Views.LessonSearchPopover).render().$el,closeable:!0,dismissible:!0,placement:"left",title:LLMS.l10n.translate("Add an Existing Lesson"),trigger:"manual",width:340,onShow:function(s){e(".webui-popover-backdrop").one("click",function(){WebuiPopovers.hide(t.target)})},onHide:function(){console.log("hiding")}})}}),s.Views.Tutorial=Backbone.View.extend({el:"#llms-builder-tutorial",events:{"click #llms-start-tut":"start"},template:wp.template("llms-builder-tutorial-template"),is_active:!1,current_step:0,steps:[],get_current_step:function(){return this.steps[this.current_step]},initialize:function(){this.listenTo(i.Syllabus.collection,"add",this.maybe_render),this.listenTo(i.Syllabus.collection,"remove",this.maybe_render),this.listenTo(i.Syllabus.collection,"sync",this.maybe_render),this.steps=window.llms_builder.tutorial},maybe_render:function(){i.Syllabus.collection.length?this.$el.fadeOut(200):this.render()},render:function(){return this.$el.html(this.template()),this.$el.fadeIn(200),this},start:function(e){e.preventDefault(),this.show_next_step(0)},show_next_step:function(t){this.current_step=t;var s=this,i=this.get_current_step(),n=e('<div class="llms-tutorial-content" />');n.append("<p>"+i.content_main+"</p>"),i.content_action&&n.append("<p><strong>"+i.content_action+"</strong></p>"),i.buttons&&e.each(i.buttons,function(t,s){var i=e('<button class="llms-button-primary small" type="button">'+s+"</button>");n.append(i)}),WebuiPopovers.show(i.el,{animation:"pop",content:n,closeable:!0,placement:i.placement||"auto",title:this.current_step+1+". "+i.title,trigger:"manual",width:340,onShow:function(t){s.is_active=!0,e(i.el).add(t.find("button")).one("click",function(){t.remove(),s.current_step<s.steps.length-1?s.show_next_step(s.current_step+1):s.is_active=!1})},onHide:function(){s.is_active=!1}})}});var i={Course:new s.Views.Course({model:new s.Models.Course(window.llms_builder.course)}),Syllabus:new s.Views.SectionList,Status:{saving:[],add:function(e){this.saving.push(e),this.update_dom()},remove:function(e){this.saving=_.without(this.saving,e),this.update_dom()},update_dom:function(){var t=this.saving.length?"saving":"complete";e("#save-status").attr("data-status",t)}}};i.Tools=new s.Views.Tools,i.Tutorial=new s.Views.Tutorial,e(".wrap.llms-course-builder").on("click","a, button",function(t){var s=e(this);if(i.Tutorial.is_active){var n=i.Tutorial.get_current_step();e(n.el)!==s&&(t.preventDefault(),e(n.el).fadeOut(100).fadeIn(300))}});var n;e(window).on("resize",function(){clearTimeout(n),n=setTimeout(function(){t()},250)}),t(),e(window).on("beforeunload",function(e){if(i.Status.saving.length)return LLMS.l10n.translate("If you leave now your changes may not be saved!")}),window.llms_builder.Instance=i}(jQuery);