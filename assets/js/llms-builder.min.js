!function(e){window.llms=window.llms||{},window.llms.builder=function(){function t(t,s,l){var l=l?l:s.order,n=wp.template("llms-lesson-template"),a=n(s),i=e("#llms-section-"+t),o=i.find(".llms-lessons");o.find(".llms-lesson").length?o.find(".llms-lesson:nth-child("+(l-1)+")").after(a):o.append(a)}function s(s,l){e.each(l,function(e,l){t(s,l)})}function l(t,l,n){var n=void 0===n||n,l=l?l:t.order,a=wp.template("llms-section-template"),i=e(a(t)),o=e("#llms-sections");$section=e("#llms-section-"+t.id),o.find(".llms-section").length?o.find(".llms-section:nth-child("+(l-1)+")").after(i):o.append(i),n&&t.lessons&&(s(t.id,t.lessons),i.attr("data-loaded","yes"))}function n(t){e.each(t,function(t,s){return s.title?void l(s):(e("#llms-builder-load-sections").show(),!1)})}this.$wrapper=null,this.init=function(){this.$wrapper=e(".llms-course-builder.wrap"),this.save_status=null,this.$save_status=e("#save-status"),setTimeout(function(){wp.heartbeat.connectNow()},5e3),console.log(window.llms_course),n(window.llms_course.sections),this.bind()},this.bind=function(){var t=this;t.sortable(),e("#llms-builder-load-sections").on("click",function(e){e.preventDefault(),t.make_request("load_sections",{course:t.get_unloaded_sections()},function(e){console.log(e)})}),t.$wrapper.on("click",'a[href="#llms-toggle"]',function(s){s.preventDefault(),t.toggle_item(e(this).closest(".llms-builder-item"))}),t.$wrapper.on("click",'a[href="#llms-toggle-all"]',function(t){t.preventDefault();var s="open"===e(this).attr("data-action")?"addClass":"removeClass";e(".llms-builder-item")[s]("opened")}),t.$wrapper.on("dblclick","[data-llms-editable]",function(s){s.preventDefault(),t.make_editable(e(this))}),t.$wrapper.on("focusout blur","input.llms-inline-edit",function(s){s.preventDefault(),t.save_edits(e(this))}),t.$wrapper.on("keypress","input.llms-inline-edit",function(t){var s=e(this);switch(t.keyCode){case 13:s.trigger("blur")}})},this.get_unloaded_sections=function(){var e=window.llms_course.sections;for(var t in e)console.log(e[t]),e[t].lessons&&delete e[t];return console.log(e),e},this.make_editable=function(t){var s,l=t.text(),n=(t.attr("data-llms-editable"),"text");t.addClass("active"),"text"===n&&(s=e('<input class="llms-inline-edit" data-original="'+l+'" type="text" value="'+l+'">')),t.html(s),s.focus(),s[0].setSelectionRange(l.length,l.length)},this.save_edits=function(e){var t=this,s=e.closest(".llms-inline-edit-wrap"),l={id:s.closest("[data-id]").attr("data-id"),field:s.attr("data-llms-editable"),value:e.val()};l.value===e.attr("data-original")?s.text(l.value).removeClass("active"):t.make_request("save_edits",l,function(e){e.success&&e.data.value&&s.text(e.data.value).removeClass("active")})},this.sortable=function(){e(".llms-sections").sortable({handle:".drag-section",items:".llms-section",placeholder:"llms-section llms-sortable-placeholder",start:function(t,s){e(".llms-sections").addClass("dragging")},stop:function(t,s){e(".llms-sections").removeClass("dragging")}}),e(".llms-lessons").sortable({connectWith:".llms-lessons",handle:".drag-lesson",items:".llms-lesson",placeholder:"llms-lesson llms-sortable-placeholder",start:function(t,s){e(".llms-lessons").addClass("dragging")},stop:function(t,s){s.item.removeAttr("style").closest(".llms-section").addClass("opened"),e(".llms-lessons").removeClass("dragging")},over:function(t,s){e("#"+t.target.offsetParent.id).addClass("hover-opened")},out:function(t,s){e("#"+t.target.offsetParent.id).removeClass("hover-opened")}})},this.make_request=function(t,s,l,n){var a=this;n=n||a.$wrapper,s=e.extend({action:"llms_builder",method:t},s),LLMS.Ajax.call({data:s,beforeSend:function(){n.addClass("processing"),LLMS.Spinner.start(n)},success:function(e){console.log(e),LLMS.Spinner.stop(n),n.removeClass("processing"),l(e)}})},this.toggle_item=function(t){var l=this,n=t.hasClass("opened")?"close":"open";if("close"===n)t.removeClass("opened");else if(t.addClass("opened"),"no"===t.attr("data-loaded")){var a={id:t.attr("data-id")};l.make_request("load_item",a,function(t){if(t.success&&t.data.item&&t.data.item_type)switch(t.data.item_type){case"section":s(t.data.item.id,t.data.item.lessons),e("#llms-section-"+t.data.item.id).attr("data-loaded","yes"),l.sortable()}},t)}},this.init()};new window.llms.builder}(jQuery);