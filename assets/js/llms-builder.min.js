!function(e){var t={Collections:{},Models:{},Views:{},Methods:{get_last_section:function(){return s.Syllabus.collection.at(s.Syllabus.collection.length-1)},draggable:function(){e("#llms-new-section").draggable({cancel:!1,connectToSortable:".llms-sections",helper:function(){var e=new t.Models.Section({id:_.uniqueId("section_temp_")});return new t.Views.Section({model:e}).render().$el},start:function(){e(".llms-sections").addClass("dragging")},stop:function(){e(".llms-sections").removeClass("dragging")}}),e("#llms-new-lesson").draggable({cancel:!1,connectToSortable:".llms-lessons",helper:function(){var e=new t.Models.Lesson({id:_.uniqueId("lesson_temp_")});return new t.Views.Lesson({model:e}).render().$el},start:function(){e(".llms-lessons").addClass("dragging")},stop:function(){e(".llms-lessons").removeClass("dragging")}})},sortable:function(){e(".llms-sections").sortable({cursor:"move",cursorAt:{top:10,left:10},handle:".drag-section",items:".llms-section",placeholder:"llms-section llms-sortable-placeholder",tolerance:"pointer",start:function(t,s){s.item.css("height","auto"),e(".llms-sections").addClass("dragging")},stop:function(t,s){s.item.trigger("drop-section",s.item.index()),e(".llms-sections").removeClass("dragging")}}),e(".llms-lessons").sortable({cursor:"move",cursorAt:{top:10,left:10},connectWith:".llms-lessons",handle:".drag-lesson",items:".llms-lesson",placeholder:"llms-lesson llms-sortable-placeholder",tolerance:"pointer",start:function(t,s){e(".llms-lessons").addClass("dragging")},stop:function(t,s){t.stopPropagation();var o=s.item.attr("data-section-id"),n=s.item.closest(".llms-section").attr("data-id");console.log(o,n),s.item.trigger("drop-lesson",[s.item,n,o]),s.item.removeAttr("style").closest(".llms-section").addClass("opened"),e(".llms-lessons").removeClass("dragging")},receive:function(e,t){t.item.trigger("update-parent",t.item),t.item.removeAttr("style").closest(".llms-section").addClass("opened")},over:function(t,s){e("#"+t.target.offsetParent.id).addClass("hover-opened")},out:function(t,s){e("#"+t.target.offsetParent.id).removeClass("hover-opened")}})}},Mixins:{EditableView:{events:{"keydown .llms-editable-title":"on_keydown"},on_keydown:function(e){e.stopPropagation();var t=e.which||e.keyCode;switch(t){case 9:this.save_edits(e);break;case 13:e.preventDefault(),this.save_edits(e),e.target.blur();break;case 27:e.preventDefault(),this.revert_edits(e),e.target.blur()}},revert_edits:function(t){var s=e(t.target),o=s.attr("data-original-content");s.text(o)},save_edits:function(t){var o=e(t.target),n=o.text(),i="edit_"+this.model.id;this.model.set("title",n).save(null,{beforeSend:function(){s.Status.add(i)},success:function(e){s.Status.remove(i)}})}},ShiftableView:{events:{"click .llms-action-icon.shift-down":"shift_down","click .llms-action-icon.shift-up":"shift_up"},shift_down:function(e){e.stopPropagation(),e.preventDefault(),this.$el.trigger("update-sort",[this.model,this.model.get("order")+1,this.model.collection])},shift_up:function(e){e.stopPropagation(),e.preventDefault(),this.$el.trigger("update-sort",[this.model,this.model.get("order")-1,this.model.collection])}},SortableView:{events:{"update-sort":"update_sort"},sort_collection:function(e){e.each(function(e,t){e.set("order",t+1)}),e.trigger("rerender")},update_sort:function(e,t,s,o,n,i){e.stopPropagation(),i=void 0===i||i;var l=!n||o===n;remove_from_collection=l?o:n,remove_from_collection&&remove_from_collection.remove(t),remove_from_collection&&!l&&(this.sort_collection(n),n.sync_order()),o.add(t,{at:s-1}),this.sort_collection(o),i&&o.sync_order()}},SortableCollection:{comparator:"order",events:{"change:order":"sort"},next_order:function(){return this.length?this.last().get("order")+1:1},sync_order:function(){var e=_.uniqueId("saving_");this.sync("update",this,{beforeSend:function(){s.Status.add(e)},success:function(t){s.Status.remove(e)}})}},Syncable:{url:ajaxurl,action:"llms_builder",sync:function(e,t,s){if("undefined"==typeof s.data&&(s.data={}),t instanceof Backbone.Model?object_type="model":t instanceof Backbone.Collection&&(object_type="collection"),s.data.course_id=window.llms_builder.id,s.data.action_type=e,s.data.object_type=object_type,s.data.data_type=t.type_id,s.data._ajax_nonce=wp_ajax_data.nonce,void 0===s.data.action&&void 0!==this.action&&(s.data.action=this.action),"read"===e)return Backbone.sync(e,t,s);var o=this.toJSON(),n={};return o instanceof Array?n.models=o:n.model=o,_.extend(s.data,n),s.emulateJSON=!0,Backbone.sync.call(this,"create",t,s)}}}};t.Models.Course=Backbone.Model.extend(_.defaults({type_id:"course",defaults:function(){return{title:"New Course",edit_url:"",view_url:""}}},t.Mixins.Syncable)),t.Models.Lesson=Backbone.Model.extend(_.defaults({type_id:"lesson",get_section:function(){return s.Syllabus.collection.get(this.get("section_id"))},defaults:function(){var e=this.collection?this.collection.next_order():1,s=t.Methods.get_last_section().id;return{title:"New Lesson",type:"lesson",order:e,section_id:s,edit_url:"",view_url:"",date_available:"",days_before_available:"",drip_method:"",has_content:!1,is_free:!1,prerequisite:!1,quiz:!1}}},t.Mixins.Syncable)),t.Models.Section=Backbone.Model.extend(_.defaults({type_id:"section",get_next:function(){return this.collection.at(this.collection.indexOf(this)+1)},get_prev:function(){return this.collection.at(this.collection.indexOf(this)-1)},is_last:function(){return this.get("order")===this.collection.length},defaults:function(){var e=this.collection?this.collection.next_order():1;return{title:"New Section",type:"section",order:e}}},t.Mixins.Syncable)),t.Collections.Lessons=Backbone.Collection.extend(_.defaults({model:t.Models.Lesson,type_id:"lesson"},t.Mixins.Syncable,t.Mixins.SortableCollection)),t.Collections.Sections=Backbone.Collection.extend(_.defaults({model:t.Models.Section,type_id:"section",parse:function(e){return e.data}},t.Mixins.Syncable,t.Mixins.SortableCollection)),t.Views.Course=Backbone.View.extend(_.defaults({attributes:function(){return{"data-id":this.model.id}},className:"llms-builder-item llms-lesson",el:"#llms-course-info",id:function(){return"llms-course-"+this.model.id},tagName:"div",template:_.template(e("#llms-course-template").html()),initialize:function(){this.render()},render:function(){return this.$el.html(this.template(this.model.toJSON())),this}},t.Mixins.EditableView)),t.Views.Lesson=Backbone.View.extend(_.defaults({attributes:function(){return{"data-id":this.model.id,"data-section-id":this.model.get("section_id")}},className:"llms-builder-item llms-lesson",events:_.defaults({"drop-lesson":"drop","update-parent":"update_parent","click .llms-action-icon.section-prev":"section_prev","click .llms-action-icon.section-next":"section_next","click .llms-action-icon.trash":"delete_lesson"},t.Mixins.EditableView.events,t.Mixins.ShiftableView.events),id:function(){return"llms-lesson-"+this.model.id},tagName:"li",template:_.template(e("#llms-lesson-template").html()),delete_lesson:function(e){e.stopPropagation(),e.preventDefault();var t=LLMS.l10n.translate("Are you sure you want to permanently delete this lesson?");if(window.confirm(t)){var o="delete_"+this.model.id;this.model.destroy({beforeSend:function(){s.Status.add(o)},success:function(e){s.Status.remove(o)}})}},drop:function(e,t,o,n){var i=this,l=s.Syllabus.collection.get(o).Lessons.collection,a=this.model.collection?s.Syllabus.collection.get(n).Lessons.collection:null,c=!0;if(!this.model.collection){var r=i.model.id;c=!1,i.model.set("section_id",o),l.create(i.model,{beforeSend:function(){s.Status.add(r)},success:function(e){s.Status.remove(r),i.model.collection.sync_order()}})}this.$el.trigger("update-sort",[this.model,t.index()+1,l,a,c])},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},section_next:function(){var t=this.model.get_section(),s=t.get_next(),o=t.Lessons.collection;to_collection=s.Lessons.collection,e("#llms-section-"+s.id).addClass("opened"),this.model.set("section_id",s.id),this.$el.trigger("update-sort",[this.model,1,to_collection,o])},section_prev:function(){var t=this.model.get_section(),s=t.get_prev(),o=t.Lessons.collection;to_collection=s.Lessons.collection,e("#llms-section-"+s.id).addClass("opened"),this.model.set("section_id",s.id),this.$el.trigger("update-sort",[this.model,to_collection.next_order(),to_collection,o])},update_parent:function(t,s){this.model.set("section_id",e(s).closest(".llms-section").attr("data-id"))}},t.Mixins.EditableView,t.Mixins.ShiftableView)),t.Views.Section=Backbone.View.extend(_.defaults({attributes:function(){return{"data-id":this.model.id}},className:"llms-builder-item llms-section",events:_.defaults({"drop-section":"drop","click .llms-action-icon.expand":"lessons_show","click .llms-action-icon.collapse":"lessons_hide","click .llms-action-icon.trash":"delete_section"},t.Mixins.EditableView.events,t.Mixins.ShiftableView.events),id:function(){return"llms-section-"+this.model.id},tagName:"li",template:_.template(e("#llms-section-template").html()),initialize:function(){this.listenTo(this.model,"sync",this.render)},drop:function(e,t){var o=this,n=!0;if(!this.model.collection){var i=o.model.id;n=!1,s.Syllabus.collection.create(o.model,{beforeSend:function(){s.Status.add(i)},success:function(e){s.Status.remove(i),o.model.collection.sync_order()}})}o.$el.trigger("update-sort",[o.model,t+1,o.model.collection,null,n])},delete_section:function(e){if(e.stopPropagation(),e.preventDefault(),this.model.Lessons.collection.length)return void alert(LLMS.l10n.translate("You must remove all lessons before deleting a section."));var t="delete_"+this.model.id;this.model.destroy({beforeSend:function(){s.Status.add(t)},success:function(e){s.Status.remove(t)}})},lessons_hide:function(e){e.preventDefault(),this.$el.removeClass("opened")},lessons_show:function(e){e.preventDefault(),this.$el.addClass("opened")},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.model.Lessons=new t.Views.LessonList({el:this.$el.find(".llms-lessons"),collection:new t.Collections.Lessons}),this.model.Lessons.collection.add(this.model.get("lessons")),this.$el.attr("id")!=this.model.id&&(this.$el.attr("id",this.id()),this.$el.attr(this.attributes())),this}},t.Mixins.EditableView,t.Mixins.ShiftableView)),t.Views.LessonList=Backbone.View.extend(_.defaults({initialize:function(){this.listenTo(this.collection,"add",this.add_one),this.listenTo(this.collection,"destroy",this.destroy_one),this.listenTo(this.collection,"rerender",this.render),t.Methods.sortable()},add_one:function(e){var s=new t.Views.Lesson({model:e});this.$el.append(s.render().el)},destroy_one:function(e,t){this.sort_collection(t),t.sync_order()},render:function(){return this.$el.children().remove(),this.collection.each(this.add_one,this),this}},t.Mixins.SortableView)),t.Views.SectionList=Backbone.View.extend(_.defaults({el:e("#llms-sections"),collection:new t.Collections.Sections,initialize:function(){var t=this;this.listenTo(this.collection,"add",this.add_one),this.listenTo(this.collection,"destroy",this.destroy_one),this.listenTo(this.collection,"rerender",this.render),this.collection.fetch({beforeSend:function(){LLMS.Spinner.start(t.$el),LLMS.Spinner.start(e("#llms-spinner-el"),"small")},success:function(e){LLMS.Spinner.stop(t.$el)}})},add_one:function(e){var s=new t.Views.Section({model:e});this.$el.append(s.render().el)},destroy_one:function(e,t){this.sort_collection(t),t.sync_order()},render:function(){return this.$el.children().remove(),this.collection.each(this.add_one,this),this}},t.Mixins.SortableView)),t.Views.Tools=Backbone.View.extend({el:e("#llms-builder-tools"),events:{"click button.llms-add-item":"add_item","click a.bulk-toggle":"bulk_toggle"},add_item:function(o){o.preventDefault();var n=e(o.target),i=n.attr("data-model"),l="section"===i?s.Syllabus.collection:t.Methods.get_last_section().Lessons.collection,a=_.uniqueId(i+"_temp_");l.create({id:a},{beforeSend:function(){s.Status.add(a)},success:function(e){s.Status.remove(a)}});var c=e("#llms-"+i+"-"+a);c.addClass("brand-new"),setTimeout(function(){c.removeClass("brand-new")},10),"lesson"===i&&c.closest(".llms-section").addClass("opened");var r=e("#llms-course-syllabus");r.animate({scrollTop:r[0].scrollHeight-r[0].clientHeight},200),t.Methods.sortable()},bulk_toggle:function(t){t.preventDefault();var s=e(t.target),o=s.attr("data-action");e(".llms-section .llms-action-icon."+o).trigger("click")}});var s={Course:new t.Views.Course({model:new t.Models.Course(window.llms_builder)}),Syllabus:new t.Views.SectionList,Tools:new t.Views.Tools,Status:{saving:[],add:function(e){this.saving.push(e),this.update_dom()},remove:function(e){this.saving=_.without(this.saving,e),this.update_dom()},update_dom:function(){console.log(this.saving);var t=this.saving.length?"saving":"complete";e("#save-status").attr("data-status",t)}}};t.Methods.draggable(),t.Methods.sortable(),e(".llms-course-builder").height(e(window).height()-62),e(window).on("beforeunload",function(e){if(s.Status.saving.length)return LLMS.l10n.translate("If you leave now your changes may not be saved!")})}(jQuery);